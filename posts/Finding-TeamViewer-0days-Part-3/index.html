<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Finding TeamViewer 0days - Part III" /><meta name="author" content="Peter Gabaldon" /><meta property="og:locale" content="en" /><meta name="description" content="Finding TeamViewer 0days. Part 3: Putting it all together. PARTY TIME :)!" /><meta property="og:description" content="Finding TeamViewer 0days. Part 3: Putting it all together. PARTY TIME :)!" /><link rel="canonical" href="https://petergabaldon.github.io/posts/Finding-TeamViewer-0days-Part-3/" /><meta property="og:url" content="https://petergabaldon.github.io/posts/Finding-TeamViewer-0days-Part-3/" /><meta property="og:site_name" content="Peter Gabaldon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-10-04T00:00:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Finding TeamViewer 0days - Part III" /><meta name="twitter:site" content="@PedroGabaldon" /><meta name="twitter:creator" content="@Peter Gabaldon" /><meta name="google-site-verification" content="n4hbrMWNSEClBGstZ5tfJRPe9iWSPul3FA1_3mEJFgQ" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Peter Gabaldon"},"description":"Finding TeamViewer 0days. Part 3: Putting it all together. PARTY TIME :)!","url":"https://petergabaldon.github.io/posts/Finding-TeamViewer-0days-Part-3/","@type":"BlogPosting","headline":"Finding TeamViewer 0days - Part III","dateModified":"2024-10-11T20:57:41+02:00","datePublished":"2024-10-04T00:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://petergabaldon.github.io/posts/Finding-TeamViewer-0days-Part-3/"},"@context":"https://schema.org"}</script><title>Finding TeamViewer 0days - Part III | Peter Gabaldon</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-N6LPQ2XQ6P"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-N6LPQ2XQ6P'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/Peter_avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Peter Gabaldon</a></div><div class="site-subtitle font-italic">Cybersecurity blog.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/PeterGabaldon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/PedroGabaldon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Finding TeamViewer 0days - Part III</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><p>&nbsp;&nbsp;&nbsp;</p><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Finding TeamViewer 0days - Part III</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 4, 2024, 12:00 AM +0200" > Oct 4, 2024 <i class="unloaded">2024-10-04T00:00:00+02:00</i> </span> by <span class="author"> Peter Gabaldon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Oct 11, 2024, 8:57 PM +0200" > Oct 11, 2024 <i class="unloaded">2024-10-11T20:57:41+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1016 words">5 min</span></div></div><div class="post-content"><h1 id="finding-teamviewer-0days-part-3-putting-it-all-together-party-time-">Finding TeamViewer 0days. Part 3: Putting it all together. PARTY TIME :)!</h1><p>Now comes the interesting part. I am sorry about the two last lazy parts, but I wanted to explain the whole process :).</p><p>Because I had spoiled you, we already know that TV is not filtering the parameter sent by the client to ask for the driver installation nor signature check, etc.</p><p>So the idea that we will review in this part is: we will spoof a TV client an asks for a VPN Driver installation but indicating another INF. I reutilized the same original INF of TeamViewer but in another (non-privileged) path renaming the “bad” driver to teamviewervpn.sys, as this is the driver name being targeted by the original INF.</p><p>First of all, you can find the project here:</p><ul><li><a href="https://github.com/PeterGabaldon/CVE-2024-7479_CVE-2024-7481" target="_blank">https://github.com/PeterGabaldon/CVE-2024-7479_CVE-2024-7481</a></ul><h2 id="important-note">IMPORTANT NOTE</h2><p>This bypasses also TeamViewer option <em>Changes require administrative rights on this computer</em>.</p><p>This check is only effective via the GUI, as <em>TeamViewer options</em> is disabled when clicking the button with an unprivileged user. But it is possible to connect to the socket and perform the arbitrary driver load.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620220926.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620220926.png" alt="" /></a></p><h2 id="important-note-ii">IMPORTANT NOTE II</h2><p>The exploit is version dependant because of the IPC message where the client specified its PID and another data among the version. The version of the client must match the version of the SYSTEM service. The exploit must be modified (lines 140 to 143) in Main.cpp to the TeamViewer_service.exe version that is being targeted.</p><h2 id="coding-the-exploit">Coding the Exploit</h2><p>We will start by defining the structures of the IPC messages involved.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620194205.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620194205.png" alt="" /></a></p><p>We will use it to send the necessary messages over the sockets using the TV IPC protocol.</p><p>We also will need the MD5 implementation, which I will skip. I have also used the following <em>hpp</em> for hexadecimal output printing.</p><ul><li><a href="https://github.com/zmb3/hexdump/blob/master/Hexdump.hpp" target="_blank">https://github.com/zmb3/hexdump/blob/master/Hexdump.hpp</a></ul><p>First of all, we will start connecting to the socket.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620194441.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620194441.png" alt="" /></a></p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620194456.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620194456.png" alt="" /></a></p><p>I decided to not use <em>Completion I/O Port</em> nor <em>Overlapped IO</em>. Technically, TV is listening like any other socket, so I will just connect <em>normally</em>.</p><p>One we have connected to <em>5939/tcp</em>, we need to send the first message, which is the first authentication one where the client sends it challenge.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620194739.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620194739.png" alt="" /></a></p><p><code class="language-plaintext highlighter-rouge">IPC_CLIENTE_CHALLENGE_AUTH ipcClientAuth1 = { { 0x08,0x00,0x01,0x00,0x1d,0x00,0x00,0x00,0x2d,0x02,0x09,0x10,0x00,0x00,0x00 }, {0xb7,0x48,0x77,0x26,0x8a,0x72,0xb8,0xf0,0xfe,0x57,0x04,0x03,0xfc,0x64,0x2e,0xb0}, {0xfe,0x01,0x00,0x00,0x00,0x01} };</code></p><p>We can always same the same challenge, it does not matter.</p><p>Then, we will receive the response from the server containing its challenge plus the response to our. We can just ignore the response and calculate the correct response for its challenge.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620194946.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620194946.png" alt="" /></a> <a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620195003.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620195003.png" alt="" /></a></p><p>And then <em>send</em> the calculated response in an <em>Authentication Message</em>.</p><p>Now it is time to send the <em>Control IPC</em> message indicating the PID of the process. As I stated in the first part, I have not reversed the rest of the fields, but just indicating the correct PID and a correct identifier at the end is sufficient.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620195140.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620195140.png" alt="" /></a></p><p>After that the service start to sends us some messages about configuration, it tries to sync some config. We just need to read all this packets, but it is not necessary to do anything with this information.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620195325.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620195325.png" alt="" /></a> <a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620195505.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620195505.png" alt="" /></a> <a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620195604.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620195604.png" alt="" /></a></p><p>After that then comes the most interesting part. We are ready to send the <em>Driver Install</em> request.</p><h3 id="important-note-1">IMPORTANT NOTE</h3><p>I do not know why because I have not analyzed it, but it appears that not all paths works. At first I thought it was the length, but then tried different lengths and ones worked while others not. I think that maybe I got the service a bit crazy with so many tests. I ended up using the following path, <strong>which can be created by a non privileged user by default in Windows</strong>.</p><ul><li>C:\Not Program F\aaaaaaaaaa\bbb\AnotherThingg.inf</ul><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620200006.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620200006.png" alt="" /></a></p><p>The length in the IPC message is just the length of the body data, does not take into account the header. Also, it does not take into account the two bytes of the NULL BYTE (two bytes because is <em>wide string</em>). The IPC message does not <em>null-terminate</em> the strings.</p><p>So we need to calculate the current length taking that into account.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620200155.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620200155.png" alt="" /></a></p><p>Then we are ready to send the magic :).</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620200211.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620200211.png" alt="" /></a></p><h2 id="elevating-to-kernel">Elevating to Kernel</h2><p>At first I thought that we could use the INF to create an arbitrary service running as SYSTEM and elevate privileges that way. But the helper program of TV ends calling <code class="language-plaintext highlighter-rouge">UpdateDriverForPlugAndPlayDevicesA</code> without verification of the signature (<em>Catalog File</em>).</p><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/api/newdev/nf-newdev-updatedriverforplugandplaydevicesa" target="_blank">https://learn.microsoft.com/en-us/windows/win32/api/newdev/nf-newdev-updatedriverforplugandplaydevicesa</a></ul><p>This function updates the INF for an existing hardware based on the hardware ID. I have not found a way to perform the arbitrary service creation. Nevertheless, here is and example INF file.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre><td class="rouge-code"><pre>; ExampleService.inf
; INF file to create a service that executes a binary as SYSTEM

[Version]
Signature="$WINDOWS NT$"
Class=Service
ClassGuid={4D36E97D-E325-11CE-BFC1-08002BE10318}
Provider=%ProviderName%
DriverVer=06/16/2024,1.0.0.0

[DestinationDirs]
DefaultDestDir = 12 ; DIRID_DRIVERS

[SourceDisksNames]
1 = %DiskName%,,,""

[SourceDisksFiles]
ExampleService.exe = 1

[Manufacturer]
%ManufacturerName%=Example,NTx86,NTamd64

[Example.NTx86]
%ServiceName%=ExampleService_Install, Root\LEGACY_ExampleService

[Example.NTamd64]
%ServiceName%=ExampleService_Install, Root\LEGACY_ExampleService

[ExampleService_Install]
CopyFiles = ExampleService_CopyFiles
AddService = ExampleService, 0x00000002, ExampleService_Service_Inst

[ExampleService_CopyFiles]
ExampleService.exe

[ExampleService_Service_Inst]
DisplayName    = %ServiceName%
ServiceType    = 0x10 ; SERVICE_WIN32_OWN_PROCESS
StartType      = 2    ; SERVICE_AUTO_START
ErrorControl   = 1    ; SERVICE_ERROR_NORMAL
ServiceBinary  = %12%\ExampleService.exe
StartName      = LocalSystem

[Strings]
ProviderName="Example Provider"
ManufacturerName="Example Manufacturer"
ServiceName="Example Service"
DiskName="Example Installation Disk"
</pre></table></code></div></div><p>It is necessary to generate the <em>CAT</em> with <em>makecat</em>.</p><ul><li><a href="https://learn.microsoft.com/en-us/windows/win32/seccrypto/makecat" target="_blank">https://learn.microsoft.com/en-us/windows/win32/seccrypto/makecat</a></ul><p>Finally, I ended up using a easier approach. Let’s use <em>BYOVD, Bring You Own Vulnerable Driver</em> with the tool <em>BYOVDKit</em>:</p><ul><li><a href="https://github.com/Hagrid29/BYOVDKit" target="_blank">https://github.com/Hagrid29/BYOVDKit</a></ul><p>I just re-used the same INF and CAT of original TeamViewer but replace <em>teamviewervpn.sys</em> with the driver we want to load and rename or copy the original <em>INF</em>, in this case *AnotherThingg.inf.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201127.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201127.png" alt="" /></a></p><p>We then launch our exploit and the driver gets loaded.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201213.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201213.png" alt="" /></a> <a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201232.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201232.png" alt="" /></a></p><p>We can then leverage the vulnerable driver to elevate privileges.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201350.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201350.png" alt="" /></a></p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201500.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201500.png" alt="" /></a></p><p>We will copy the <em>Primary Access Token</em> of PID 4, i.e, the SYSTEM process.</p><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201617.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201617.png" alt="" /></a></p><p>NICE, WE ARE SYSTEM :D</p><p>USER TO KERNEL.</p><p>If you want to test and load another driver do not remember to delete the one we have installed from the <em>Windows CAT Store</em>.</p><ul><li>C:\Windows\system32&gt;pnputil -enum-drivers</ul><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201830.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201830.png" alt="" /></a></p><ul><li>C:\Windows\system32&gt;pnputil -delete-driver oem13.inf -force -uninstall</ul><p><a href="../../assets/img/finding-tv-0days-3/Pasted image 20240620201840.png" target="_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/finding-tv-0days-3/Pasted image 20240620201840.png" alt="" /></a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/en/'>en</a>, <a href='/categories/windows-security/'>Windows security</a>, <a href='/categories/teamviewer/'>TeamViewer</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/cybersecurity/" class="post-tag no-text-decoration" >cybersecurity</a> <a href="/tags/cve-2024-7479/" class="post-tag no-text-decoration" >CVE-2024-7479</a> <a href="/tags/cve-2024-7481/" class="post-tag no-text-decoration" >CVE-2024-7481</a> <a href="/tags/zdi-24-1289/" class="post-tag no-text-decoration" >ZDI-24-1289</a> <a href="/tags/zdi-24-1290/" class="post-tag no-text-decoration" >ZDI-24-1290</a> <a href="/tags/tv-2024-1006/" class="post-tag no-text-decoration" >tv-2024-1006</a> <a href="/tags/red-team/" class="post-tag no-text-decoration" >red team</a> <a href="/tags/pentesting/" class="post-tag no-text-decoration" >pentesting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Finding TeamViewer 0days - Part III - Peter Gabaldon&url=https://petergabaldon.github.io/posts/Finding-TeamViewer-0days-Part-3/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Finding TeamViewer 0days - Part III - Peter Gabaldon&u=https://petergabaldon.github.io/posts/Finding-TeamViewer-0days-Part-3/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Finding TeamViewer 0days - Part III - Peter Gabaldon&url=https://petergabaldon.github.io/posts/Finding-TeamViewer-0days-Part-3/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/FortiGate-VPN-SSL-Honeypot/">FortiGate VPN-SSL Honeypot</a><li><a href="/posts/Bypass-Azure-Admin-Approval-Mode-Enumeration/">Bypass Azure Admin Approval Mode for User Consent Workflow When Enumerating</a><li><a href="/posts/Finding-TeamViewer-0days-Part-1/">Finding TeamViewer 0days - Part I</a><li><a href="/posts/Finding-TeamViewer-0days-Part-3/">Finding TeamViewer 0days - Part III</a><li><a href="/posts/Diamond-And-Sapphire-Tickets/">Diamond And Sapphire Tickets</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cybersecurity/">cybersecurity</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/red-team/">red team</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/cve-2024-7479/">CVE-2024-7479</a> <a class="post-tag" href="/tags/cve-2024-7481/">CVE-2024-7481</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/tv-2024-1006/">tv-2024-1006</a> <a class="post-tag" href="/tags/zdi-24-1289/">ZDI-24-1289</a> <a class="post-tag" href="/tags/zdi-24-1290/">ZDI-24-1290</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Playing-With-Windows-Security-Part-1/"><div class="card-body"> <span class="timeago small" > Feb 4, 2021 <i class="unloaded">2021-02-04T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Playing With Windows Security - Part 1</h3><div class="text-muted small"><p> Windows Authentication. In this first part of Windows hacking we will be covering aspects related on how Windows authentication works. I’m coming from Linux ecosystem so sometimes I will try to co...</p></div></div></a></div><div class="card"> <a href="/posts/Playing-With-Windows-Security-Part-2/"><div class="card-body"> <span class="timeago small" > Feb 21, 2021 <i class="unloaded">2021-02-21T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Playing With Windows Security - Part 2</h3><div class="text-muted small"><p> Kerberos Authentication Protocol After the first part at which we talked about authentication in Windows and explained how attacks like Pass-The-Hash works. At this part we are going to analyse Ke...</p></div></div></a></div><div class="card"> <a href="/posts/Diamond-And-Sapphire-Tickets/"><div class="card-body"> <span class="timeago small" > Oct 14, 2022 <i class="unloaded">2022-10-14T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Diamond And Sapphire Tickets</h3><div class="text-muted small"><p> Kerberos Diamond and Sapphire Tickets As you may known, one of the approaches for persistence in a Windows Active Directory are the well-known techniques Golden Ticket and Silver Ticket. In the po...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Finding-TeamViewer-0days-Part-2/" class="btn btn-outline-primary"><p>Finding TeamViewer 0days - Part II</p></a> <a href="/posts/Bypass-Azure-Admin-Approval-Mode-Enumeration/" class="btn btn-outline-primary"><p>Bypass Azure Admin Approval Mode for User Consent Workflow When Enumerating</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/PeterGabaldon">Pedro Gabaldon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cybersecurity/">cybersecurity</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/red-team/">red team</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/cve-2024-7479/">CVE 2024 7479</a> <a class="post-tag" href="/tags/cve-2024-7481/">CVE 2024 7481</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/tv-2024-1006/">tv 2024 1006</a> <a class="post-tag" href="/tags/zdi-24-1289/">ZDI 24 1289</a> <a class="post-tag" href="/tags/zdi-24-1290/">ZDI 24 1290</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://petergabaldon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
