<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="theme" content="Chirpy v2.7.2"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="Playing With Windows Security - Part 2" /><meta name="author" content="Peter Gabaldon" /><meta property="og:locale" content="en" /><meta name="description" content="Kerberos Authentication Protocol" /><meta property="og:description" content="Kerberos Authentication Protocol" /><link rel="canonical" href="https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-2/" /><meta property="og:url" content="https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-2/" /><meta property="og:site_name" content="Peter Gabaldon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-02-21T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Playing With Windows Security - Part 2" /><meta name="twitter:site" content="@PedroGabaldon" /><meta name="twitter:creator" content="@Peter Gabaldon" /><meta name="google-site-verification" content="n4hbrMWNSEClBGstZ5tfJRPe9iWSPul3FA1_3mEJFgQ" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Peter Gabaldon"},"description":"Kerberos Authentication Protocol","url":"https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-2/","@type":"BlogPosting","headline":"Playing With Windows Security - Part 2","dateModified":"2021-06-26T13:11:37+02:00","datePublished":"2021-02-21T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-2/"},"@context":"https://schema.org"}</script><title>Playing With Windows Security - Part 2 | Peter Gabaldon</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="preload" href="/assets/css/post.css" as="style"><link rel="stylesheet" href="/assets/css/post.css"><link rel="preload" as="style" href="/assets/css/lib/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/css/lib/bootstrap-toc.min.css" /> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="/assets/js/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-N6LPQ2XQ6P"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-N6LPQ2XQ6P'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar/Peter_avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Peter Gabaldon</a></div><div class="site-subtitle font-italic">Cybersecurity blog.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/tabs/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tabs/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/tabs/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tabs/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/PeterGabaldon" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/PedroGabaldon" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['',''].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Playing With Windows Security - Part 2</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><p>&nbsp;&nbsp;&nbsp;</p><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Playing With Windows Security - Part 2</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Feb 21, 2021, 12:00 AM +0100" > Feb 21, 2021 <i class="unloaded">2021-02-21T00:00:00+01:00</i> </span> by <span class="author"> Peter Gabaldon </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Jun 26, 2021, 1:11 PM +0200" > Jun 26, 2021 <i class="unloaded">2021-06-26T13:11:37+02:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1828 words">10 min</span></div></div><div class="post-content"><h1 id="kerberos-authentication-protocol">Kerberos Authentication Protocol</h1><p>After the first part at which we talked about authentication in Windows and explained how attacks like Pass-The-Hash works. At this part we are going to analyse Kerberos, a centralized authentication protocol designed by MIT around 1980s. Also they develop <a href="https://web.mit.edu/kerberos/" target="\_blank"><code class="language-plaintext highlighter-rouge">krb</code></a>, the Kerberos Linux (<code class="language-plaintext highlighter-rouge">kfw</code> for Windows), implementation. It is not common but you might come with a Linux environment using Kerberos(especially with RedHat). You will see Kerberos almost always in Windows domain environs. Understanding Kerberos will help us to learn how the whole family of Kerberos attacks work and why some of them are so powerful, for example Golden Ticket, that cannot be mitigated at all but detected and stopped.</p><p>Kerberos is the hound of Hades -God of the underworld and brother of Zeus- in Greek mythology. Kerberos uses a KDC, or Key Distribution Center, which has the job of authenticating users and granting services tickets, or TGS. We will see Kerberos on a theoretical point of view, in part 3 we will pwn an Active Directory test lab using <a href="https://github.com/microsoft/WSLab" target="\_blank">WSLab</a> and we will put in practise all the things learned.</p><h2 id="key-concepts">Key Concepts</h2><ul><li>Kerberos Realm<li>KDC (Key Distribution Center)<li>Tickets</ul><h2 id="attacks">Attacks</h2><ul><li>Overpass-The-Hash<li>Pass-The-Ticket<li>Golden Ticket<li>Silver Ticket<li>Kerberoasting<li>ASReproasting</ul><h1 id="kerberos-realm">Kerberos Realm</h1><p>The Kerberos Realm is simply over which domain the authorithation server can authenticate users or takes part. Say we have a host <code class="language-plaintext highlighter-rouge">service1</code> within the domain <code class="language-plaintext highlighter-rouge">corp.local</code>. We would like to to access a service at <code class="language-plaintext highlighter-rouge">service1.corp.local</code> and to do that we authenticate using Kerberos and obtain a TGT using <code class="language-plaintext highlighter-rouge">kinit</code>. Now, <code class="language-plaintext highlighter-rouge">kinit</code> needs to authenticate versus the KDC, but, which KDC? In order to know which configuration of Kerberos is needed we identify it with the <code class="language-plaintext highlighter-rouge">Realm</code>. It is a form of identification, simply.</p><p>In Windows sytems it is the same as the domain name. As you know Windows AD is an integrated system of DNS, Kerberos, LDAP… Internally names are converted to Kerberos principals, it is then when we will have the <code class="language-plaintext highlighter-rouge">Realm</code>. For example, say we have and AD domain <code class="language-plaintext highlighter-rouge">corp.local</code> and Kerberos authentication working, that KDC on the Domain Controller can authenticate users belonging to <code class="language-plaintext highlighter-rouge">corp.local</code>. On Linux systems, you do not have the KDC linked or attached to one domain it is possible to define wich Realm to use for each domain. so you can define multiple realms in <code class="language-plaintext highlighter-rouge">/etc/krb5.conf</code> and when some authentication flow is going on the realm will be used to differentiate between domains to apply some config or another.</p><p>Take a look at this <code class="language-plaintext highlighter-rouge">krb5.conf</code> config file example:</p><div class="language-conf highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>[<span class="n">libdefaults</span>]
	<span class="n">default_realm</span> = <span class="n">ATHENA</span>.<span class="n">MIT</span>.<span class="n">EDU</span>

[<span class="n">realms</span>]
<span class="c"># use "kdc = ..." if realm admins haven't put SRV records into DNS
</span>	<span class="n">ATHENA</span>.<span class="n">MIT</span>.<span class="n">EDU</span> = {
		<span class="n">admin_server</span> = <span class="n">kerberos</span>.<span class="n">mit</span>.<span class="n">edu</span>
	}
	<span class="n">ANDREW</span>.<span class="n">CMU</span>.<span class="n">EDU</span> = {
		<span class="n">admin_server</span> = <span class="n">kdc</span>-<span class="m">01</span>.<span class="n">andrew</span>.<span class="n">cmu</span>.<span class="n">edu</span>
	}

[<span class="n">domain_realm</span>]
	<span class="n">mit</span>.<span class="n">edu</span> = <span class="n">ATHENA</span>.<span class="n">MIT</span>.<span class="n">EDU</span>
	<span class="n">csail</span>.<span class="n">mit</span>.<span class="n">edu</span> = <span class="n">CSAIL</span>.<span class="n">MIT</span>.<span class="n">EDU</span>
	.<span class="n">ucsc</span>.<span class="n">edu</span> = <span class="n">CATS</span>.<span class="n">UCSC</span>.<span class="n">EDU</span>

[<span class="n">logging</span>]
<span class="c">#	kdc = CONSOLE
</span></pre></table></code></div></div><p>Inside square brackets we have just section names. We should focus at lines 6-11 and lines 14-16. At lines 6 to 11 we have the definition of the <code class="language-plaintext highlighter-rouge">realms</code> section, at which the configuration of the Realms <code class="language-plaintext highlighter-rouge">ATHENA.MIT.EDU</code> and <code class="language-plaintext highlighter-rouge">ANDREW.CMU.EDU</code> takes part (specifically we define the location of the KDCs). And as of lines 14 to 16 we are defining 3 domains mapped to some realm: <code class="language-plaintext highlighter-rouge">mit.edu</code> and all hosts inside it are mapped to <code class="language-plaintext highlighter-rouge">ATHENA.MIT.EDU</code> (except csail.mit.edut), <code class="language-plaintext highlighter-rouge">csail.mit.edut</code> mapped to <code class="language-plaintext highlighter-rouge">CSAIL.MIT.EDU</code> and all hosts under <code class="language-plaintext highlighter-rouge">ucsc.edu</code> and itself mapped to <code class="language-plaintext highlighter-rouge">CATS.UCSC.EDU</code>.</p><p><code class="language-plaintext highlighter-rouge">Note: The realm is uppercase by definition and normally the same as the domain name although actually it can be whatever string</code>.</p><h1 id="kdc-key-distribution-center">KDC (Key Distribution Center)</h1><p>The Key Distribution Center is the key part on Kerberos, it is the server that manages authorization itself and generetes the corresponding tickets, Ticket Granting Ticket, or TGT, and Ticket Granting Service, or TGS. Actually we can define de KDC as AS + TGS, i.e, on the one hand it acts as a Authorization Server(AS) checking users present correct credentials and on the other hand it acts as a Ticket Granting Server, creating and sending tickets. Imagine you want to access an SMB resource, so Kerberos authentication flow will communicate with de KDC asking for authentication to that service (that is uniquely identified using the Service Principal Name, <a href="https://docs.microsoft.com/en-us/windows/win32/ad/service-principal-names">SPN</a>). The flow is as follows:</p><ul><li>The KDC checks credentials, they are OK so the KDC respond back sending the TGT and you are authenticated.<li>Now you need a TGS to present it to the SMB service, you ask the KDC that you want to access that SMB service presening the TGT and because the TGT is correct you are given with a TGS that can be used to authenticate to that service.<li>You then go to the SMB service, present the TGS, the SMB service asks Kerberos and Kerberos says that the TGS is correct so you are now able to access the SMB resources (additionally the PAC can be verified asking the KDC and a response to the user is also optional).</ul><h1 id="tickets">Tickets</h1><p>In Kerberos the authenticy is demostrated with <code class="language-plaintext highlighter-rouge">Tickets</code>. Tickets are just a concept of security structures containing the identification information. We will not dye in the details of the structure of a ticket because it does not concern us in a Pentest exercise, we need to put the eye on more at the network part and how a user is authenticated. In Kerberos we have essetially to types of tickets:</p><ul><li>Ticket-Granting-Ticket(TGT): The TGT is obtained after a successful authenticatin and it will permit you to access the services on the Kerberos ecosystem submitting it to the KDC.<li>Ticket-Granting-Service(TGS): Once you have a correct TGT you could ask the KDC for a TGS to access some service. The TGS will grant you authentication over a concrete service.</ul><p>Both contains, among other things, one key part: the PAC, or Privileged Attribute Certificate. This structure contains the security information about the user, like his User ID o the IDs of his membership groups.</p><h1 id="dying-into-the-details">Dying into the details</h1><h2 id="authenticating-and-obtaining-a-tgt">Authenticating and obtaining a TGT</h2><p>The flow to authenticate and finally obtaining a TGT starts with the client requesting authenticating on the AS. The client sends an <code class="language-plaintext highlighter-rouge">AS-REQ</code>. The key information of this message is as follows:</p><ul><li>Username<li>Kerberos service name<li>Timestamp encrypted with user hash<li>Nonce</ul><p>After that, the server will respond with the response: <code class="language-plaintext highlighter-rouge">AS-REP</code>. Considering the authentication was succesful and the KDC didn´t denied you from login you will recieve the TGT and a session key, this last thing will be used latelly when communicating again to the KDC but this time as a authenticated user. For example, requesting a TGS will need the session key. The <code class="language-plaintext highlighter-rouge">AS-REP</code> response contains two key parts:</p><ul><li>First, information to the user:<ol><li>Username<li>Session key and TGT lifetime encrypted with user hash.</ol><li>The TGT itself, encrypted with the KRBTGT account hash, it contains:<ol><li>Session key<li>TGT lifetime<li>User Token</ol></ul><p>The following diagram shows the flow: <a href="../../assets/img/playing-win-sec-2/kerb-auth.png" target="\_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/playing-win-sec-2/kerb-auth.png" alt="Logon sessions" /></a></p><h2 id="accesing-services-after-succesful-authentication">Accesing services (after succesful authentication)</h2><p>First of all the client needs to get a TGS:</p><p>After the flow described above, when a user wants to access some service it will request the KDC for a TGS(Ticket Granting Service) at the TGS(Ticket Granting Server) part, sending the request: <code class="language-plaintext highlighter-rouge">TGT-REQ</code>. This message contains this information:</p><ul><li>SPN<li>Username and timestamp encrypted with session key<li>TGT</ul><p>The KDC validates this information, and if it is correct it constructs the TGS, that will grant you access to the service. This TGS is sent on <code class="language-plaintext highlighter-rouge">TGT-REP</code>. The information contained in that message is as follows:</p><ul><li>SPN, timestamp and service session key encrypted with session key<li>The TGS itself encrypted with the service hash, that contains the following:<ol><li>Username<li>SPN<li>Session service key<li>User Token<li>Timestamp</ol></ul><p>The following diagram ilustrates the exchanges:</p><p><a href="../../assets/img/playing-win-sec-2/service-auth.png" target="\_blank"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="../../assets/img/playing-win-sec-2/service-auth.png" alt="Logon sessions" /></a></p><p>Once you have the TGS you can present it the service, sending an <code class="language-plaintext highlighter-rouge">AP-REQ</code> containing the TGS, getting access to it, for example, to an HTTP(s) server.</p><p>Optionally, the service could verify the PAC with the KDC. If it is the case, the service will contact the KDC sending <code class="language-plaintext highlighter-rouge">VERIFY_PAC</code> and the KDC will respond with <code class="language-plaintext highlighter-rouge">VERIFY_PAC-REP</code>.</p><p>Also it is optional to the service to respond with <code class="language-plaintext highlighter-rouge">AP-REP</code>.</p><p><code class="language-plaintext highlighter-rouge">Note: Remember that TGS and TGT both contains the PAC with the security attributes of the user, although it is not shown in the diagrams because it is take for granted.</code></p><h1 id="kerberos-attacks">Kerberos attacks</h1><p>Some we are moving to the fun part :D. After studying key concepts of Kerberos and how this authenticaton protocol works we can now try to figure how to take advantage of this scenario. Also, you will notice that attacks on Kerberos are easier to understand and more simple. In my opinion, understading the Windows authentication ecosystem and attacks related to it is more complex.</p><h2 id="overpass-the-hash">Overpass-The-Hash</h2><p>Overpass-The-Hash is a very simple attack. Think that in the authentication part you do not need to know the user password. If you have the NTLM hash of a valid user on Kerberos you can just use it to send a valid <code class="language-plaintext highlighter-rouge">AP-REQ</code> and you will be granted with a TGT authenticating that user. That is, simple.</p><h2 id="pass-the-ticket">Pass-The-Ticket</h2><p>Do you Remember <a href="https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-1/#pass-the-hash" target="\_blank">Pass-The-Hash</a> from previous post? But essentially the same but with a ticket. If you steal some TGT to a user you could just use it. So tools like Mimikatz can patch the LSASS memory and add a TGT that will grant you access to whatever that TGT security information grant access.</p><h2 id="golden-ticket-and-silver-ticket">Golden Ticket and Silver Ticket</h2><p>The TGT information is encrypted with the KRBTGT hash, so anyone with that hash could create any TGT. That is Golden Ticket, having the “master” hash in posession allows you to create any TGT as you want, having any information you want. You could create a TGT that impersonates user with RID 500, or a TGT that authenticates the Domain Admin, belonging to whatever groups you want… And the worst is that <code class="language-plaintext highlighter-rouge">Golden Ticket</code> is (almost) indetectable, think about it.</p><p>On the other hand we have <code class="language-plaintext highlighter-rouge">Silver Ticket</code>. The same concept as Golden Ticket but this time having stolen the hash of a Kerberos service. So, you can “spawn” TGSs authenticating to that service.</p><h2 id="kerberoasting">Kerberoasting</h2><p>Having a ticket could permit you to recover the passphrase used to derive the hash that was used to encrypt the information of the ticket if the password is not strong enough. For example, imagine that a user account has a service with Kerberos authentication and that user has a weak password. That password is derived in a NTLM hash and that hash is used to encrypt the TGS. Obtaining a TGS for that service could be abused with a bruteforce attack, recovering the account password.</p><h2 id="asreproasting">ASReproasting</h2><p>Sometimes users are configured in Kerberos without Pre-Authentication, so the information sent in <code class="language-plaintext highlighter-rouge">AS-REQ</code> is not checked and the <code class="language-plaintext highlighter-rouge">AS-REP</code> is just sent back. Remember that some info is encrypted with the user hash so we can use the <code class="language-plaintext highlighter-rouge">AS-REP</code> response to crack offline any user(with no Pre-Auth) hash.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/en/'>en</a>, <a href='/categories/windows-security/'>Windows security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/windows/" class="post-tag no-text-decoration" >windows</a> <a href="/tags/cybersecurity/" class="post-tag no-text-decoration" >cybersecurity</a> <a href="/tags/kerberos/" class="post-tag no-text-decoration" >kerberos</a> <a href="/tags/red-team/" class="post-tag no-text-decoration" >red team</a> <a href="/tags/pentesting/" class="post-tag no-text-decoration" >pentesting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Playing With Windows Security - Part 2 - Peter Gabaldon&url=https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Playing With Windows Security - Part 2 - Peter Gabaldon&u=https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Playing With Windows Security - Part 2 - Peter Gabaldon&url=https://petergabaldon.github.io/posts/Playing-With-Windows-Security-Part-2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/FortiGate-VPN-SSL-Honeypot/">FortiGate VPN-SSL Honeypot</a><li><a href="/posts/Bypass-Azure-Admin-Approval-Mode-Enumeration/">Bypass Azure Admin Approval Mode for User Consent Workflow When Enumerating</a><li><a href="/posts/Finding-TeamViewer-0days-Part-1/">Finding TeamViewer 0days - Part I</a><li><a href="/posts/Finding-TeamViewer-0days-Part-3/">Finding TeamViewer 0days - Part III</a><li><a href="/posts/Diamond-And-Sapphire-Tickets/">Diamond And Sapphire Tickets</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cybersecurity/">cybersecurity</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/red-team/">red team</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/cve-2024-7479/">CVE-2024-7479</a> <a class="post-tag" href="/tags/cve-2024-7481/">CVE-2024-7481</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/tv-2024-1006/">tv-2024-1006</a> <a class="post-tag" href="/tags/zdi-24-1289/">ZDI-24-1289</a> <a class="post-tag" href="/tags/zdi-24-1290/">ZDI-24-1290</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Diamond-And-Sapphire-Tickets/"><div class="card-body"> <span class="timeago small" > Oct 14, 2022 <i class="unloaded">2022-10-14T00:00:00+02:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Diamond And Sapphire Tickets</h3><div class="text-muted small"><p> Kerberos Diamond and Sapphire Tickets As you may known, one of the approaches for persistence in a Windows Active Directory are the well-known techniques Golden Ticket and Silver Ticket. In the po...</p></div></div></a></div><div class="card"> <a href="/posts/Playing-With-Windows-Security-Part-1/"><div class="card-body"> <span class="timeago small" > Feb 4, 2021 <i class="unloaded">2021-02-04T00:00:00+01:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Playing With Windows Security - Part 1</h3><div class="text-muted small"><p> Windows Authentication. In this first part of Windows hacking we will be covering aspects related on how Windows authentication works. I’m coming from Linux ecosystem so sometimes I will try to co...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Playing-With-Windows-Security-Part-1/" class="btn btn-outline-primary"><p>Playing With Windows Security - Part 1</p></a> <a href="/posts/Diamond-And-Sapphire-Tickets/" class="btn btn-outline-primary"><p>Diamond And Sapphire Tickets</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/PeterGabaldon">Pedro Gabaldon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy/" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-xl-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/cybersecurity/">cybersecurity</a> <a class="post-tag" href="/tags/pentesting/">pentesting</a> <a class="post-tag" href="/tags/red-team/">red team</a> <a class="post-tag" href="/tags/windows/">windows</a> <a class="post-tag" href="/tags/cve-2024-7479/">CVE 2024 7479</a> <a class="post-tag" href="/tags/cve-2024-7481/">CVE 2024 7481</a> <a class="post-tag" href="/tags/kerberos/">kerberos</a> <a class="post-tag" href="/tags/tv-2024-1006/">tv 2024 1006</a> <a class="post-tag" href="/tags/zdi-24-1289/">ZDI 24 1289</a> <a class="post-tag" href="/tags/zdi-24-1290/">ZDI 24 1290</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://petergabaldon.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"><div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>{categories}</div><div><i class="fa fa-tag fa-fw"></i>{tags}</div></div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>' }); </script>
